name: Deploy to Server

on:
  push:
    branches:
      - ismail-admin-panel
  workflow_dispatch:  # Manual trigger button
    inputs:
      confirm_deployment:
        description: 'Type "deploy" to confirm'
        required: true
        default: 'no'

jobs:
  validate:
    name: Validate Backend and Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            front-end/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install --legacy-peer-deps
      
      - name: Install curl (if needed)
        run: |
          if ! command -v curl &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y curl
          fi
      
      - name: Test backend startup
        working-directory: ./backend
        env:
          PORT: 5000
          NODE_ENV: test
          CLIENT_URL: http://localhost:3000
          SUPABASE_URL: https://test.supabase.co
          SUPABASE_ANON_KEY: test-key
          SUPABASE_SERVICE_ROLE_KEY: test-key
          STRIPE_SECRET_KEY: sk_test_dummy_key
          JWT_SECRET: test-jwt-secret
          SESSION_SECRET: test-session-secret
        run: |
          npm start > server.log 2>&1 &
          SERVER_PID=$!
          
          cleanup() {
            kill $SERVER_PID 2>/dev/null || true
          }
          trap cleanup EXIT
          
          for i in {1..30}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "✅ Backend validation passed!"
              break
            fi
            sleep 1
          done
      
      - name: Install frontend dependencies
        working-directory: ./front-end
        run: npm install --legacy-peer-deps
      
      - name: Build frontend
        working-directory: ./front-end
        env:
          CI: false
          SKIP_PREFLIGHT_CHECK: true
        run: npm run build
      
      - name: Verify build
        working-directory: ./front-end
        run: |
          if [ ! -d "build" ]; then
            echo "❌ Build failed"
            exit 1
          fi
          echo "✅ All validations passed!"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    # Only deploy if manually triggered AND confirmation given
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_deployment == 'deploy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 38877 }}
          timeout: 300s
          script: |
            set -e
            
            cd ~/admin-pannel/admin-panel
            git fetch origin ismail-admin-panel
            git reset --hard origin/ismail-admin-panel
            
            # Backend
            cd backend
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 18 || nvm install 18
            
            npm install --legacy-peer-deps
            pm2 restart backend || pm2 start npm --name "backend" -- start
            pm2 save
            
            # Frontend
            cd ../front-end
            npm install --legacy-peer-deps
            npm run build
            sudo rm -rf /var/www/html/admin-panel/*
            sudo cp -r build/* /var/www/html/admin-panel/ || sudo cp -r build/* /var/www/html/
            sudo systemctl restart apache2
            
            echo "✅ Deployment completed!"
            echo "Frontend: https://dev.duhanashrah.ai"
            echo "Backend: https://dev.duhanashrah.ai/api"