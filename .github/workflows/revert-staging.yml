name: Revert Staging Code

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA or tag to revert to (leave empty to revert last commit)'
        required: false
        type: string
      create_revert_commit:
        description: 'Create a revert commit (true) or reset hard (false)'
        required: true
        type: boolean
        default: true

jobs:
  revert:
    name: Revert Staging Code
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Verify PAT_TOKEN exists
        run: |
          if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
            echo "âŒ PAT_TOKEN secret is not configured!"
            echo ""
            echo "This workflow requires a Personal Access Token (PAT) to push changes."
            echo "The default GITHUB_TOKEN doesn't have write permissions for this repository."
            echo ""
            echo "To fix this:"
            echo "1. Go to: https://github.com/settings/tokens"
            echo "2. Click 'Generate new token (classic)'"
            echo "3. Select the 'repo' scope (full control of private repositories)"
            echo "4. Copy the generated token"
            echo "5. Go to your repository: Settings â†’ Secrets and variables â†’ Actions"
            echo "6. Add a new secret named 'PAT_TOKEN' with the token value"
            echo ""
            exit 1
          else
            echo "âœ… PAT_TOKEN is configured"
          fi
      
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: staging-ismail-admin-panel
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Revert to previous code
        id: revert
        run: |
          if [ "${{ github.event.inputs.create_revert_commit }}" = "true" ]; then
            echo "ðŸ”„ Creating revert commit for staging..."
            
            if [ -z "${{ github.event.inputs.commit_sha }}" ]; then
              # Revert the last commit
              LAST_COMMIT=$(git rev-parse HEAD)
              git revert --no-edit HEAD
              echo "âœ… Reverted commit: $LAST_COMMIT"
            else
              # Revert to specific commit
              COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
              
              # Check if it's a tag
              if git rev-parse "$COMMIT_SHA" >/dev/null 2>&1; then
                echo "ðŸ“ Found commit/tag: $COMMIT_SHA"
                
                # Get all commits between current HEAD and the target commit
                CURRENT_SHA=$(git rev-parse HEAD)
                TARGET_SHA=$(git rev-parse "$COMMIT_SHA")
                
                if [ "$CURRENT_SHA" = "$TARGET_SHA" ]; then
                  echo "âš ï¸ Already at target commit. Nothing to revert."
                  exit 0
                fi
                
                # Check if target is an ancestor
                if git merge-base --is-ancestor "$TARGET_SHA" "$CURRENT_SHA"; then
                  # Target is in history, revert commits between them
                  COMMITS_TO_REVERT=$(git rev-list --reverse "$TARGET_SHA"..HEAD)
                  for commit in $COMMITS_TO_REVERT; do
                    git revert --no-edit "$commit" || {
                      echo "âš ï¸ Could not revert commit $commit (might have conflicts)"
                      git revert --abort 2>/dev/null || true
                    }
                  done
                  echo "âœ… Reverted to commit: $TARGET_SHA"
                else
                  echo "âŒ Target commit is not in current branch history"
                  exit 1
                fi
              else
                echo "âŒ Commit or tag not found: $COMMIT_SHA"
                exit 1
              fi
            fi
          else
            echo "ðŸ”„ Performing hard reset on staging..."
            
            if [ -z "${{ github.event.inputs.commit_sha }}" ]; then
              # Reset to previous commit
              git reset --hard HEAD~1
              echo "âœ… Reset to previous commit"
            else
              # Reset to specific commit
              COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
              
              if git rev-parse "$COMMIT_SHA" >/dev/null 2>&1; then
                git reset --hard "$COMMIT_SHA"
                echo "âœ… Reset to commit: $COMMIT_SHA"
              else
                echo "âŒ Commit or tag not found: $COMMIT_SHA"
                exit 1
              fi
            fi
          fi
      
      - name: Push changes
        if: steps.revert.outcome == 'success'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Use PAT_TOKEN for authentication (verified in earlier step)
          echo "ðŸ”‘ Using Personal Access Token (PAT_TOKEN) for authentication"
          
          # Verify token is set
          if [ -z "$PAT_TOKEN" ]; then
            echo "âŒ PAT_TOKEN environment variable is empty!"
            exit 1
          fi
          
          # Configure remote URL with token for authentication
          git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          
          # Debug: Show which user the token belongs to (without exposing the token)
          echo "ðŸ” Verifying token permissions..."
          git ls-remote --heads origin staging-ismail-admin-panel > /dev/null 2>&1 || {
            echo "âŒ Token authentication failed - cannot access repository"
            exit 1
          }
          echo "âœ… Token authentication successful"
          
          if [ "${{ github.event.inputs.create_revert_commit }}" = "true" ]; then
            echo "ðŸ“¤ Pushing revert commit to staging..."
            if git push origin "HEAD:staging-ismail-admin-panel"; then
              echo "âœ… Staging revert completed successfully!"
            else
              echo "âŒ Push failed. This usually means:"
              echo "   1. The PAT_TOKEN doesn't have 'repo' scope"
              echo "   2. The PAT_TOKEN is invalid or expired"
              echo "   3. The PAT_TOKEN doesn't have write access to this repository"
              echo ""
              echo "To fix:"
              echo "   1. Verify PAT_TOKEN secret exists: Settings â†’ Secrets and variables â†’ Actions"
              echo "   2. Check token has 'repo' scope: https://github.com/settings/tokens"
              echo "   3. Regenerate token if needed and update the PAT_TOKEN secret"
              echo ""
              echo "Debug info:"
              echo "  Repository: ${GITHUB_REPOSITORY}"
              echo "  Branch: staging-ismail-admin-panel"
              exit 1
            fi
          else
            echo "ðŸ“¤ Force pushing reset to staging..."
            if git push origin "HEAD:staging-ismail-admin-panel" --force; then
              echo "âœ… Staging revert completed successfully!"
            else
              echo "âŒ Force push failed. See error message above for details."
              exit 1
            fi
          fi
      
      - name: Create summary
        if: always()
        run: |
          echo "## Staging Revert Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: staging-ismail-admin-panel (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: ${{ github.event.inputs.commit_sha || 'Last commit' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: ${{ github.event.inputs.create_revert_commit == 'true' && 'Revert commit' || 'Hard reset' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.revert.outcome }}" >> $GITHUB_STEP_SUMMARY
